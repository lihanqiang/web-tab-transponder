var thisId,storageKey,msgCallback;function addEvent(t,e){window.addEventListener?window.addEventListener(t,e):window.attachEvent("on"+t,e)}function removeEvent(t,e){window.removeEventListener?window.removeEventListener(t,e):window.detachEvent("on"+t,e)}function setLocal(t,e){window.localStorage.setItem(t,JSON.stringify(e))}function getpagetype(){var t="page";return window.frames&&window.parent&&window.frames.length!==window.parent.frames.length&&(t="iframe"),t}function getPageData(){return window.location?{href:window.location.href,pathname:window.location.pathname,hostname:window.location.hostname,port:window.location.port,protocol:window.location.protocol,hash:window.location.hash,search:window.location.search,pagetype:getpagetype()}:{}}function StorageTransponder(t){if("string"!=typeof t||!t)throw new Error('the param "id" is required, which is a string, but not ""!');if(thisId=t,this.destoryed=!1,storageKey="__&&transponderKeydoNotDelete&&__","object"!=typeof localStorage)throw new Error('"localStorage" is not supported in this environment!')}Function.prototype.apply||(Function.prototype.apply=function(obj,args){var i=0,ary=[],str;if(args)for(var len=args.length;i<len;i++)ary[i]="args["+i+"]";obj._apply=this,str="obj._apply("+ary.join(",")+")";try{return eval(str)}catch(t){}finally{delete obj._apply}}),Function.prototype.call||(Function.prototype.call=function(t){for(var e=1,o=[],r=arguments.length;e<r;e++)o[e-1]=arguments[e];return this.apply(t,o)}),StorageTransponder.prototype.send=function(t,e){if(this.destoryed)throw new Error("this instance has been destoryed!");var o=getPageData();if(void 0!==e)for(var r=e instanceof Array?e:[e],n=0;n<r.length;n++){var a=r[n];if("string"!=typeof a||!a)throw new Error('param "toId" is Array<string> or just a string, but not a ""!');o.id=thisId,setLocal(storageKey,{random:Math.random(),transferId:a,data:t,from:o})}else setLocal(storageKey,{random:Math.random(),transferId:void 0,data:t,from:o});return this},StorageTransponder.prototype.messageListener=function(t){var e=t.key,o=t.newValue,r=JSON.parse(o);if(e===storageKey&&r&&r.random){var n=r.transferId,a=r.data,i=r.from,s={data:a,from:i},d=i.id;n?d!==thisId&&n===thisId&&msgCallback.call(this,s):d!==thisId&&msgCallback.call(this,s)}},StorageTransponder.prototype.onMessage=function(t){return msgCallback=t||function(){},addEvent("storage",this.messageListener),this},StorageTransponder.prototype.destory=function(){removeEvent("storage",this.messageListener),this.destoryed=!0},window.Transponder=StorageTransponder;